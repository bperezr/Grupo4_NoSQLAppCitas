<div class="content">
    <div class="content__title">
        <h1>Horarios Disponibles</h1>
    </div>

    <section class="main__container">
        <div class="container__header">
            <label for="doctorSelect" class="label__doctor">Elige un Doctor:</label>
            <select id="doctorSelect" class="select__doctor">
                <option value="">Seleccionar Doctor</option>
                <!-- Los doctores se agregan dinámicamente -->
            </select>
        </div>

        <div class="table-container">
            <table id="tablaHorarios" class="display compact nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>Doctor</th>
                        <th>Hora Inicio</th>
                        <th>Hora Fin</th>
                        <th>Motivo Consulta</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se llenan los horarios mediante JS -->
                </tbody>
            </table>
        </div>
    </section>
</div>

<!-- Modal para agendar cita -->
<div id="modalAgendar" class="modal">
    <div class="modal__content">
        <span class="modal__close" onclick="cerrarModalAgendar()">&times;</span>
        <h2>Agendar Cita</h2>
        <form id="formAgendarCita" method="POST" class="modal__form">
            <input type="text" name="motivo" id="motivo" placeholder="Motivo de la cita" required>
            <button type="submit" class="btn__agendar-nueva">Agendar</button>
        </form>
    </div>
</div>

<!-- Script para gestionar los horarios -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Cargar la lista de doctores
    fetch('/doctores/citas') 
        .then(response => response.json())
        .then(doctores => {
            const doctorSelect = document.getElementById('doctorSelect');
            doctores.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor._id;
                option.textContent = `${doctor.nombre} ${doctor.apellido}`;
                doctorSelect.appendChild(option);
            });
        })
        .catch(error => console.error('Error al obtener doctores:', error));

    // Cambio del doctor
    document.getElementById('doctorSelect').addEventListener('change', function () {
        const doctorId = this.value;
        cargarHorarios(doctorId);
    });

    // Función para cargar los horarios
    function cargarHorarios(doctorId = '') {
        fetch('/horarios')
            .then(response => response.json())
            .then(horarios => {
                const tablaBody = document.querySelector('#tablaHorarios tbody');
                tablaBody.innerHTML = ''; // Limpiar tabla

                const horariosFiltrados = doctorId ? horarios.filter(h => h.doctorId._id === doctorId) : horarios;

                if (horariosFiltrados.length > 0) {
                    horariosFiltrados.forEach(horario => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${horario.doctorId.nombre}</td>
                            <td>${new Date(horario.horaInicio).toISOString().replace('T', ' ').substring(0, 19)} UTC</td>
                            <td>${new Date(horario.horaFin).toISOString().replace('T', ' ').substring(0, 19)} UTC</td>
                            <td>
                                <input type="text" placeholder="Motivo de la cita" id="motivo-${horario._id}" required>
                            </td>
                            <td>
                                <button class="btn__agendar-nueva" data-doctor="${horario.doctorId._id}" data-horario="${horario.horaInicio}" data-id="${horario._id}">Agendar</button>
                            </td>
                        `;
                        tablaBody.appendChild(row);
                    });

                    // Asignar eventos a los botones "Agendar"
                    document.querySelectorAll('.btn__agendar-nueva').forEach(button => {
                        button.addEventListener('click', async function () {
                            const doctorId = this.getAttribute('data-doctor');
                            const fechaHora = this.getAttribute('data-horario');
                            const horarioId = this.getAttribute('data-id');
                            const motivo = document.getElementById(`motivo-${horarioId}`).value;

                            if (!motivo.trim()) {
                                alert("Por favor ingrese el motivo de la cita.");
                                return;
                            }

                            const body = {
                                doctorId,
                                fechaHora,
                                motivo
                            };

                            const response = await fetch('/agendar', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(body)
                            });

                            const result = await response.json();

                            if (response.ok) {
                                alert("Cita agendada correctamente.");
                                cargarHorarios(doctorId); // Volver a cargar horarios
                            } else {
                                alert("Error al agendar la cita: " + result.mensaje);
                            }
                        });
                    });
                } else {
                    tablaBody.innerHTML = '<tr><td colspan="5">No hay horarios disponibles.</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error al obtener horarios:', error);
                document.querySelector('#tablaHorarios tbody').innerHTML = '<tr><td colspan="5">Error al cargar los horarios.</td></tr>';
            });
    }
});
</script>




