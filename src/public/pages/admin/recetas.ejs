<div class="content">
    <div class="content__title">
        <h1>Recetas</h1>
    </div>
    <section class="main__container">
        <div class="container__header">
            <div class="btn-agregar-wrapper">
                <button onclick="abrirModal()" class="btn__agregar-nueva">
                    <i class="fa-solid fa-plus"></i> Agregar receta
                </button>
            </div>
        </div>
        <div class="table-container">
            <table id="tablaMedicamentos" class="display compact nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>Paciente</th>
                        <th>Doctor</th>
                        <th>Sucursal</th>
                        <th>Fecha entrega</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <% recetas.forEach(rec => { %>
                      <tr>
                        <td class="text-center"><%= rec.pacienteId.nombre %></td>
                        <td class="text-center"><%= rec.doctorId.nombre %></td>
                        <td class="text-center"><%= rec.sucursalId.nombre %></td>
                        <td class="text-center"><%= rec.fechaEntrega.toISOString().split('T')[0] %></td>
                        <td class="text-center"><%= rec.estado %></td>
                        <td class="text-center">
                          <form action="/recetas/eliminar/<%= rec._id %>" method="POST" style="display:inline;">
                            <button class="btn__icon" title="Eliminar" onclick="return confirm('¿Eliminar esta receta?')">
                              <i class="fa-solid fa-trash"></i>
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
            </table>
        </div>
    </section>
</div>

<div id="modalReceta" class="modal">
    <div class="modal__content">
      <span class="modal__close" onclick="cerrarModal()">&times;</span>
      <h2>Crear receta</h2>
  
      <form action="/recetas/crear" method="POST" class="modal__form" id="formCrearReceta">
        <select name="pacienteId" required>
          <option value="">Seleccione paciente</option>
          <% pacientes.forEach(p => { %>
            <option value="<%= p._id %>"><%= p.nombre %></option>
          <% }) %>
        </select>
  
        <select name="doctorId" required>
          <option value="">Seleccione doctor</option>
          <% doctores.forEach(d => { %>
            <option value="<%= d._id %>"><%= d.nombre %></option>
          <% }) %>
        </select>
  
        <select name="sucursalId" required>
          <option value="">Seleccione sucursal</option>
          <% sucursales.forEach(s => { %>
            <option value="<%= s._id %>"><%= s.nombre %></option>
          <% }) %>
        </select>
  
        <input type="date" name="fechaEntrega" required>
  
        <select name="estado" required>
          <option value="Pendiente">Pendiente</option>
          <option value="Entregado">Entregado</option>
          <option value="Cancelado">Cancelado</option>
        </select>
  
        <label>Medicamentos:</label>
        <div id="contenedorMedicamentos">
          <% medicamentos.forEach(m => { %>
            <div class="med-item">
              <label>
                <input type="checkbox" name="medicamentosSeleccionados" value="<%= m._id %>" onchange="toggleCantidadInput(this)">
                <%= m.nombre %> (<%= m.stock %> disponibles)
              </label>
              <input type="number" name="cantidades" placeholder="Cantidad" min="1" style="display:none;" data-id="<%= m._id %>">
            </div>
          <% }) %>
        </div>
  
        <textarea name="notas" placeholder="Observaciones (opcional)"></textarea>
  
        <button type="submit" class="btn__agregar-nueva">Guardar receta</button>
      </form>
    </div>
  </div>

  <script>
    function abrirModal() {
      document.getElementById("modalReceta").style.display = "block";
    }
    
    function cerrarModal() {
      document.getElementById("modalReceta").style.display = "none";
    }
    
    function toggleCantidadInput(checkbox) {
      const input = checkbox.closest('.med-item').querySelector('input[type="number"]');
      if (checkbox.checked) {
        input.style.display = 'inline-block';
        input.required = true;
      } else {
        input.style.display = 'none';
        input.required = false;
        input.value = '';
      }
    }
    
    // Confirmación antes de enviar
    const form = document.getElementById("formCrearReceta");
    if (form) {
      form.addEventListener("submit", function (e) {
        const seleccionados = [...document.querySelectorAll('input[name="medicamentosSeleccionados"]:checked')];
        if (seleccionados.length === 0) {
          e.preventDefault();
          alert("Debes seleccionar al menos un medicamento.");
          return;
        }
    
        // Agregar dinámicamente un array de medicamentos al req.body
        seleccionados.forEach(checkbox => {
          const cantidadInput = checkbox.closest('.med-item').querySelector('input[type="number"]');
          const hiddenId = document.createElement("input");
          const hiddenCantidad = document.createElement("input");
    
          hiddenId.type = "hidden";
          hiddenId.name = "medicamentos[]";
          hiddenId.value = JSON.stringify({
            medicamentoId: checkbox.value,
            cantidad: parseInt(cantidadInput.value)
          });
    
          hiddenCantidad.type = "hidden"; // para ver en inspección
          hiddenCantidad.name = "debugCantidad";
          hiddenCantidad.value = cantidadInput.value;
    
          form.appendChild(hiddenId);
          form.appendChild(hiddenCantidad);
        });
      });
    }
    </script>
