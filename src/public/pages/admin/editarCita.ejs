<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar cita</title>
  <!-- Tus CSS y font‑awesome aquí -->
</head>
<body>
  <div class="content">
    <div class="content__title">
      <h1>Editar cita</h1>
    </div>

    <form id="citaForm" action="/admin/citas/<%= cita._id %>/editar" method="POST">
      <div class="containerCitas">
        <!-- ▶ Información de la cita -->
        <div class="info-container">
          <h3 class="card__title">Información de la cita</h3>
          <div class="horaClass">
            <div class="content__title">
              <h3>Datos de la cita</h3>
            </div>

            <!-- Cédula (busca de nuevo si quieres cambiar paciente) -->
            <div class="form-group">
              <label for="Cedula">Cédula del Paciente</label>
              <div class="search-paciente">
                <input
                  type="text"
                  id="Cedula"
                  placeholder="Ingrese cédula"
                  value="<%= cita.paciente.cedula || '' %>"
                >
                <button class="btnBuscar" type="button" onclick="ConsultarCedula()">Buscar</button>
              </div>
              <div id="pacienteInfo" class="paciente-info">
                Paciente: <%= cita.paciente.nombre %> <%= cita.paciente.apellido %>
              </div>
              <input 
                type="hidden"
                name="pacienteId"
                id="pacienteIdInput"
                value="<%= cita.pacienteId %>"
              >
            </div>

            <!-- Nombre del Paciente -->
            <div class="form-group">
              <label for="Nombre">Nombre del Paciente</label>
              <input
                type="text"
                id="Nombre"
                readonly
                value="<%= cita.paciente.nombre %> <%= cita.paciente.apellido %>"
              >
            </div>

            <!-- Sucursal -->
            <div class="form-group">
              <label for="sucursalId">Sucursal</label>
              <select id="sucursalId" name="sucursalId" required>
                <option value="">Seleccione una sucursal</option>
                <% sucursales.forEach(s => { %>
                  <option
                    value="<%= s._id %>"
                    <%= s._id.toString() === cita.sucursalId.toString() ? 'selected' : '' %>
                  ><%= s.nombre %></option>
                <% }) %>
              </select>
            </div>

            <!-- Especialidad -->
            <div class="form-group">
              <label for="especialidad">Especialidad</label>
              <select id="especialidad" name="especialidadId" required>
                <option value="">Seleccione una especialidad</option>
                <% especialidades.forEach(e => { %>
                  <option
                    value="<%= e._id %>"
                    <%= e._id.toString() === cita.especialidadId.toString() ? 'selected' : '' %>
                  ><%= e.nombreEspecialidad %></option>
                <% }) %>
              </select>
            </div>

            <!-- Doctor -->
            <div class="form-group">
              <label for="doctorSelect">Doctor</label>
              <select id="doctorSelect" name="doctorId" required>
                <option value="">Seleccione un doctor</option>
                <% /* Si ya cargaste doctores en el controlador: */ %>
                <% (doctores || []).forEach(d => { %>
                  <option
                    value="<%= d._id %>"
                    <%= d._id.toString() === cita.doctorId.toString() ? 'selected' : '' %>
                  ><%= d.nombre %> <%= d.apellidos %></option>
                <% }) %>
              </select>
            </div>

            <!-- Motivo -->
            <div class="form-group">
              <label for="motivo">Motivo de la consulta</label>
              <textarea id="motivo" name="motivo" rows="2" required><%= cita.motivo %></textarea>
            </div>

            <!-- Estado oculta (podrías permitir cambiar) -->
            <input type="hidden" name="estado" value="<%= cita.estado %>">
          </div>
        </div>

        <!-- ▶ Calendario -->
        <div class="info-container borderCalendario">
          <h3 class="card__title">Seleccione la fecha</h3>
          <div class="agenda-container">
            <div class="calendar-container">
              <div class="calendar-header tituloAgenda">
                <button type="button" onclick="changeMonth(-1)">‹</button>
                <h2 id="monthYear">Mes Año</h2>
                <button type="button" onclick="changeMonth(1)">›</button>
              </div>
              <div class="calendar-grid" id="calendarGrid"></div>
            </div>
          </div>
        </div>

        <!-- ▶ Horas -->
        <div class="info-container borderCalendario">
          <h3 class="card__title">Seleccione la hora</h3>
          <div class="time-slot-container horaClass">
            <h3>Horas disponibles</h3>
            <div id="timeSlots" class="time-slot-grid"></div>
          </div>
        </div>

        <!-- Hidden para pasar fecha y hora seleccionadas -->
        <% 
          // Pre‑llenamos los hidden con la fecha y hora de la cita existente
          const isoDate = cita.fechaHora.toISOString().split('T')[0];
          const isoHour = cita.fechaHora.toTimeString().substr(0,5);
        %>
        <input type="hidden" name="selectedDate" id="selectedDateInput" value="<%= isoDate %>">
        <input type="hidden" name="selectedHour" id="selectedHourInput" value="<%= isoHour %>">
      </div>

      <!-- Botón enviar -->
      <div style="display:flex;justify-content:center;margin-top:1rem;">
        <button type="submit" class="btnBuscar">Actualizar cita</button>
      </div>
    </form>
  </div>

  <!-- Scripts comunes: jQuery, tu JS de calendario, fetch de doctores, etc. -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Inicialización:
    document.addEventListener('DOMContentLoaded', () => {
      // 1) Pinta el calendario y marca selectedDate preexistente
      renderCalendar(new Date('<%= isoDate %>'));

      // 2) Carga time‑slots y marca selectedHour tras pintar el día
      cargarHoras('<%= isoDate %>', '<%= cita.doctorId %>');
      setTimeout(() => {
        // remarca la hora que ya tenía
        document.querySelectorAll('#timeSlots button')
          .forEach(btn => {
            if (btn.textContent === '<%= isoHour %>') {
              btn.classList.add('selected');
              selectedHour = '<%= isoHour %>';
            }
          });
      }, 100);

      // 3) Cargar doctores según especialidad preseleccionada
      const espSel = document.getElementById('especialidad').value;
      if (espSel) {
        fetch(`/admin/doctores/listar/${espSel}`)
          .then(r => r.json())
          .then(docs => {
            const doctorSelect = document.getElementById('doctorSelect');
            doctorSelect.innerHTML = '<option value="">Seleccione un doctor</option>';
            docs.forEach(d => {
              const opt = document.createElement('option');
              opt.value = d._id;
              opt.textContent = d.nombre + ' ' + d.apellidos;
              if (d._id === '<%= cita.doctorId.toString() %>') opt.selected = true;
              doctorSelect.appendChild(opt);
            });
          });
      }
    });
  </script>
</body>
</html>
